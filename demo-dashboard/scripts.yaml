# =============================================================================
# JOTTY HOME ASSISTANT INTEGRATION VIA HACS
# Copy and paste this at the bottom of scripts.yaml
# NOTE: All notes/lists automatically use "Home Assistant" category
# You MUST create the category "Home Assistant" in both Lists AND Notes
# =============================================================================

jotty_create_note:
  alias: 'Jotty: Create Note'
  icon: mdi:note-plus
  sequence:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: jotty.create_note
    data:
      title: '{{ states(''input_text.jotty_note_title'') }}'
      content: '{{ states(''input_text.jotty_note_content'') }}'
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_notes
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_note_title
    data:
      value: ''
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_note_content
    data:
      value: ''
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: persistent_notification.create
    data:
      title: Note Created
      message: Your note has been created!

jotty_update_note:
  alias: 'Jotty: Update Note'
  icon: mdi:content-save
  sequence:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: jotty.update_note
    data:
      note_id: '{{ states(''input_text.jotty_note_id'') }}'
      title: '{{ states(''input_text.jotty_note_title'') }}'
      content: '{{ states(''input_text.jotty_note_content'') }}'
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_notes
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: persistent_notification.create
    data:
      title: Note Updated
      message: Your note has been updated!

jotty_delete_note:
  alias: 'Jotty: Delete Note'
  icon: mdi:delete
  sequence:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: jotty.delete_note
    data:
      note_id: '{{ states(''input_text.jotty_note_id'') }}'
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_notes
  - service: input_text.set_value
    target:
      entity_id:
      - input_text.jotty_note_id
      - input_text.jotty_note_title
      - input_text.jotty_note_content
    data:
      value: ''
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: persistent_notification.create
    data:
      title: Note Deleted
      message: Your note has been deleted!

jotty_create_checklist:
  alias: 'Jotty: Create Checklist'
  icon: mdi:playlist-plus
  sequence:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: jotty.create_checklist
    data:
      title: '{{ states(''input_text.jotty_checklist_title'') }}'
      type: '{{ states(''input_select.jotty_checklist_type'') }}'
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_checklists
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_checklist_title
    data:
      value: ''
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: persistent_notification.create
    data:
      title: Checklist Created
      message: Your checklist has been created!

jotty_add_item:
  alias: 'Jotty: Add Item'
  icon: mdi:plus
  sequence:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: jotty.add_checklist_item
    data:
      checklist_id: '{{ states(''input_text.jotty_checklist_id'') }}'
      text: '{{ states(''input_text.jotty_item_text'') }}'
      status: "{% if states('input_select.jotty_checklist_type') == 'task' %}\n  {{
        states('input_select.jotty_task_status') }}\n{% endif %}\n"
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_items
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_item_text
    data:
      value: ''
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: persistent_notification.create
    data:
      title: Item Added
      message: Item added to checklist!

jotty_check_item:
  alias: 'Jotty: Check Item'
  icon: mdi:check-circle
  sequence:
  - service: jotty.check_item
    data:
      checklist_id: '{{ states(''input_text.jotty_checklist_id'') }}'
      item_index: '{{ states(''input_number.jotty_selected_item_index'') | int }}'
  - service: homeassistant.update_entity
    target:
      entity_id:
      - sensor.jotty_completed_items
      - sensor.jotty_pending_items
      - sensor.jotty_completion_rate
  - service: persistent_notification.create
    data:
      title: Item Checked
      message: Item marked as completed!

jotty_uncheck_item:
  alias: 'Jotty: Uncheck Item'
  icon: mdi:checkbox-blank-circle-outline
  sequence:
  - service: jotty.uncheck_item
    data:
      checklist_id: '{{ states(''input_text.jotty_checklist_id'') }}'
      item_index: '{{ states(''input_number.jotty_selected_item_index'') | int }}'
  - service: homeassistant.update_entity
    target:
      entity_id:
      - sensor.jotty_completed_items
      - sensor.jotty_pending_items
      - sensor.jotty_completion_rate
  - service: persistent_notification.create
    data:
      title: Item Unchecked
      message: Item marked as incomplete!

jotty_delete_checklist:
  alias: 'Jotty: Delete Checklist'
  icon: mdi:delete
  sequence:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: jotty.delete_checklist
    data:
      checklist_id: '{{ states(''input_text.jotty_checklist_id'') }}'
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_checklists
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_checklist_id
    data:
      value: ''
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.jotty_is_loading
  - service: persistent_notification.create
    data:
      title: Checklist Deleted
      message: Your checklist has been deleted!

jotty_force_update_note_picker:
  alias: 'Jotty: Force Update Note Picker'
  icon: mdi:sync
  sequence:
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_notes
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_note_picker
    data:
      options: >
        {%- set ns = namespace(items=['-- Pick a note --'], titles={}) -%}
        {%- set notes = states.sensor | selectattr('name', 'search', '^Jotty Note:')
        | rejectattr('state', 'eq', 'unavailable') | list -%}
        {%- for state in notes -%}
          {%- set title = state.state -%}
          {%- if title in ns.titles -%}
            {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
          {%- else -%}
            {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set ns2 = namespace(counts={}) -%}
        {%- for state in notes | sort(attribute='attributes.updated', reverse=true) -%}
          {%- set title = state.state -%}
          {%- set note_id = state_attr(state.entity_id, 'note_id') -%}
          {%- if ns.titles[title] > 1 -%}
            {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
            {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
            {%- set display_title = title ~ ' (' ~ note_id[-6:] ~ ')' -%}
          {%- else -%}
            {%- set display_title = title -%}
          {%- endif -%}
          {%- set ns.items = ns.items + [display_title] -%}
        {%- endfor -%}
        {{ ns.items }}

jotty_force_update_checklist_picker:
  alias: 'Jotty: Force Update Checklist Picker'
  icon: mdi:sync
  sequence:
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_checklists
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_checklist_picker
    data:
      options: >
        {%- set ns = namespace(items=['-- Pick a checklist --'], titles={}) -%}
        {%- set lists = states.sensor | selectattr('name', 'search', '^Jotty List:')
        | rejectattr('state', 'eq', 'unavailable') | list -%}
        {%- for state in lists -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- if title in ns.titles -%}
              {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
            {%- else -%}
              {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set ns2 = namespace(counts={}) -%}
        {%- for state in lists | sort(attribute='attributes.updated', reverse=true) -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- set list_id = state_attr(state.entity_id, 'checklist_id') -%}
            {%- if ns.titles[title] > 1 -%}
              {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
              {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
              {%- set display_title = title ~ ' (' ~ list_id[-6:] ~ ')' -%}
            {%- else -%}
              {%- set display_title = title -%}
            {%- endif -%}
            {%- set ns.items = ns.items + [display_title] -%}
          {%- endif -%}
        {%- endfor -%}
        {{ ns.items }}

jotty_force_update_task_picker:
  alias: 'Jotty: Force Update Task Picker'
  icon: mdi:sync
  sequence:
  - service: homeassistant.update_entity
    target:
      entity_id: sensor.jotty_total_tasks
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_task_picker
    data:
      options: >
        {%- set ns = namespace(items=['-- Pick a task list --'], titles={}) -%}
        {%- set tasks = states.sensor | selectattr('name', 'search', '^Jotty Task:')
        | rejectattr('state', 'eq', 'unavailable') | list -%}
        {%- for state in tasks -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- if title in ns.titles -%}
              {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
            {%- else -%}
              {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set ns2 = namespace(counts={}) -%}
        {%- for state in tasks | sort(attribute='attributes.updated', reverse=true) -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- set task_id = state_attr(state.entity_id, 'task_id') -%}
            {%- if ns.titles[title] > 1 -%}
              {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
              {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
              {%- set display_title = title ~ ' (' ~ task_id[-6:] ~ ')' -%}
            {%- else -%}
              {%- set display_title = title -%}
            {%- endif -%}
            {%- set ns.items = ns.items + [display_title] -%}
          {%- endif -%}
        {%- endfor -%}
        {{ ns.items }}

jotty_update_both_dropdowns:
  alias: "Jotty: Update Both Dropdowns"
  icon: mdi:sync-circle
  sequence:
    - service: script.jotty_force_update_note_picker
    - service: script.jotty_force_update_checklist_picker
    - service: script.jotty_force_update_task_picker

jotty_refresh_notifiers:
  alias: "Jotty: Refresh Notifiers"
  icon: mdi:bell-ring
  sequence:
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_available_notifiers
    - variables:
        notifiers: "{{ state_attr('sensor.jotty_available_notifiers', 'notifiers') | default([]) }}"
        options: "{{ ['Nobody'] + notifiers }}"
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_reminder_target
      data:
        options: "{{ options }}"
    - service: persistent_notification.create
      data:
        title: "Notifiers Refreshed"
        message: "Found {{ notifiers | length }} mobile app notifiers"
        notification_id: jotty_notifiers_refreshed

jotty_save_reminder:
  alias: "Jotty: Save Reminder"
  fields:
    item_id:
      description: "List/task ID"
    item_type:
      description: "checklist or task"
    targets:
      description: "Comma-separated notify service targets"
    interval:
      description: "How often to remind"
    days:
      description: "weekdays, weekends, or every_day"
    start:
      description: "Start time HH:MM"
    end:
      description: "End time HH:MM"
    custom_title:
      description: "Optional custom notification title"
    custom_message:
      description: "Optional custom notification message"
  sequence:
    - variables:
        configs: "{{ state_attr('sensor.jotty_reminders', 'configs') or {} }}"
    - condition: template
      value_template: "{{ item_id != '' and targets != '' }}"
    - variables:
        new_config:
          targets: "{{ targets }}"
          interval: "{{ interval }}"
          days: "{{ days }}"
          start: "{{ start }}"
          end: "{{ end }}"
          type: "{{ item_type }}"
          custom_title: "{{ custom_title | default('') }}"
          custom_message: "{{ custom_message | default('') }}"
          last_sent: ""
        safe_configs: "{{ configs if configs is mapping else {} }}"
        updated_configs: "{{ dict(safe_configs, **{item_id: new_config}) }}"
    - event: jotty_reminder_update
      event_data:
        configs: "{{ updated_configs }}"
    - service: persistent_notification.create
      data:
        title: "Reminder Saved"
        message: "Reminders configured for {{ targets }}"
        notification_id: jotty_reminder_saved

jotty_remove_reminder:
  alias: "Jotty: Remove Reminder"
  fields:
    item_id:
      description: "List/task ID"
  sequence:
    - variables:
        configs: "{{ state_attr('sensor.jotty_reminders', 'configs') or {} }}"
    - condition: template
      value_template: "{{ configs is mapping and item_id in configs }}"
    - variables:
        updated_configs: >
          {% set safe_configs = configs if configs is mapping else {} %}
          {% set ns = namespace(result={}) %}
          {% for key, val in safe_configs.items() %}
            {% if key != item_id %}
              {% set ns.result = dict(ns.result, **{key: val}) %}
            {% endif %}
          {% endfor %}
          {{ ns.result }}
    - event: jotty_reminder_update
      event_data:
        configs: "{{ updated_configs }}"
    - service: persistent_notification.create
      data:
        title: "Reminder Removed"
        message: "Reminder has been removed"
        notification_id: jotty_reminder_saved

jotty_update_last_sent:
  alias: "Jotty: Update Last Sent"
  fields:
    item_id:
      description: "List/task ID"
  sequence:
    - variables:
        configs: "{{ state_attr('sensor.jotty_reminders', 'configs') or {} }}"
    - condition: template
      value_template: "{{ configs is mapping and item_id in configs }}"
    - variables:
        current_config: "{{ configs[item_id] }}"
        updated_config:
          targets: "{{ current_config.targets | default(current_config.target | default('')) }}"
          interval: "{{ current_config.interval }}"
          days: "{{ current_config.days }}"
          start: "{{ current_config.start }}"
          end: "{{ current_config.end }}"
          type: "{{ current_config.type }}"
          custom_title: "{{ current_config.custom_title | default('') }}"
          custom_message: "{{ current_config.custom_message | default('') }}"
          last_sent: "{{ now().strftime('%Y-%m-%d %H:%M') }}"
        updated_configs: "{{ dict(configs, **{item_id: updated_config}) }}"
    - event: jotty_reminder_update
      event_data:
        configs: "{{ updated_configs }}"

jotty_send_note_to_devices:
  alias: "Jotty: Send Note to Devices"
  fields:
    targets:
      description: "Comma-separated notify service targets"
    title:
      description: "Note title"
    message:
      description: "Note content"
  sequence:
    - variables:
        target_list: "{{ targets.split(',') }}"
    - repeat:
        count: "{{ target_list | length }}"
        sequence:
          - service: "{{ target_list[repeat.index - 1] }}"
            data:
              title: "{{ title }}"
              message: "{{ message }}"
              data:
                tag: "jotty_note_{{ title | slugify }}"
    - service: persistent_notification.create
      data:
        title: "Note Sent"
        message: "Sent '{{ title }}' to {{ target_list | length }} device(s)"
        notification_id: jotty_note_sent

jotty_save_recurring:
  alias: "Jotty: Save Recurring"
  fields:
    item_id:
      description: "List/task ID"
    item_type:
      description: "checklist or task"
    days:
      description: "weekdays, weekends, or every_day"
    reset_times:
      description: "Comma separated times like 06:00,14:00"
  sequence:
    - variables:
        configs: "{{ state_attr('sensor.jotty_recurring', 'configs') or {} }}"
    - condition: template
      value_template: "{{ item_id != '' and reset_times != '' }}"
    - variables:
        times_list: "{{ reset_times.split(',') | map('trim') | list }}"
        new_config:
          type: "{{ item_type }}"
          days: "{{ days }}"
          reset_times: "{{ times_list }}"
        safe_configs: "{{ configs if configs is mapping else {} }}"
        updated_configs: "{{ dict(safe_configs, **{item_id: new_config}) }}"
    - event: jotty_recurring_update
      event_data:
        configs: "{{ updated_configs }}"
    - service: persistent_notification.create
      data:
        title: "Recurring Reset Saved"
        message: "Will reset at: {{ times_list | join(', ') }}"
        notification_id: jotty_recurring_saved

jotty_remove_recurring:
  alias: "Jotty: Remove Recurring"
  fields:
    item_id:
      description: "List/task ID"
  sequence:
    - variables:
        configs: "{{ state_attr('sensor.jotty_recurring', 'configs') or {} }}"
    - condition: template
      value_template: "{{ configs is mapping and item_id in configs }}"
    - variables:
        updated_configs: >
          {% set safe_configs = configs if configs is mapping else {} %}
          {% set ns = namespace(result={}) %}
          {% for key, val in safe_configs.items() %}
            {% if key != item_id %}
              {% set ns.result = dict(ns.result, **{key: val}) %}
            {% endif %}
          {% endfor %}
          {{ ns.result }}
    - event: jotty_recurring_update
      event_data:
        configs: "{{ updated_configs }}"
    - service: persistent_notification.create
      data:
        title: "Recurring Reset Removed"
        message: "Recurring reset has been removed"
        notification_id: jotty_recurring_saved

jotty_reset_checklist:
  alias: "Jotty: Reset Checklist Items"
  fields:
    checklist_id:
      description: "Checklist ID to reset"
  sequence:
    - variables:
        sensor_entity: >
          {% set ns = namespace(found='') %}
          {% for s in states.sensor %}
            {% if s.attributes.checklist_id is defined and s.attributes.checklist_id == checklist_id %}
              {% set ns.found = s.entity_id %}
            {% endif %}
          {% endfor %}
          {{ ns.found }}
    - condition: template
      value_template: "{{ sensor_entity | trim != '' }}"
    - service: homeassistant.update_entity
      data:
        entity_id: "{{ sensor_entity }}"
    - delay:
        seconds: 2
    - variables:
        flat_items: "{{ state_attr(sensor_entity, 'flat_items') | default([]) }}"
        completed_indices: >
          {% set ns = namespace(indices=[]) %}
          {% for item in flat_items %}
            {% if item.completed | default(false) == true %}
              {% set ns.indices = ns.indices + [item.index_path] %}
            {% endif %}
          {% endfor %}
          {{ ns.indices | reverse | list }}
    - repeat:
        for_each: "{{ completed_indices }}"
        sequence:
          - service: jotty.uncheck_item
            data:
              checklist_id: "{{ checklist_id }}"
              item_index: "{{ repeat.item }}"
          - delay:
              seconds: 1

jotty_reset_task:
  alias: "Jotty: Reset Task Items"
  fields:
    task_id:
      description: "Task ID to reset"
  sequence:
    - variables:
        sensor_entity: >
          {% set ns = namespace(found='') %}
          {% for s in states.sensor %}
            {% if s.attributes.task_id is defined and s.attributes.task_id == task_id %}
              {% set ns.found = s.entity_id %}
            {% endif %}
          {% endfor %}
          {{ ns.found }}
    - condition: template
      value_template: "{{ sensor_entity | trim != '' }}"
    - service: homeassistant.update_entity
      data:
        entity_id: "{{ sensor_entity }}"
    - delay:
        seconds: 2
    - variables:
        flat_items: "{{ state_attr(sensor_entity, 'flat_items') | default([]) }}"
        non_todo_indices: >
          {% set ns = namespace(indices=[]) %}
          {% for item in flat_items %}
            {% if item.status | default('todo') != 'todo' %}
              {% set ns.indices = ns.indices + [item.index_path] %}
            {% endif %}
          {% endfor %}
          {{ ns.indices | reverse | list }}
    - repeat:
        for_each: "{{ non_todo_indices }}"
        sequence:
          - service: jotty.update_task_item_status
            data:
              task_id: "{{ task_id }}"
              item_index: "{{ repeat.item }}"
              status: "todo"
          - delay:
              seconds: 1

jotty_schedule_note:
  alias: "Jotty: Schedule Note"
  fields:
    note_id:
      description: "Note ID"
    title:
      description: "Note title"
    message:
      description: "Note content"
    targets:
      description: "Comma-separated notify service targets"
    scheduled_time:
      description: "ISO datetime string for when to send"
  sequence:
    - variables:
        schedules: "{{ state_attr('sensor.jotty_scheduled_notes', 'schedules') or {} }}"
        schedule_id: "{{ (now().timestamp() * 1000) | int | string ~ '_' ~ (range(1000, 9999) | random | string) }}"
        new_schedule:
          note_id: "{{ note_id }}"
          title: "{{ title }}"
          message: "{{ message }}"
          targets: "{{ targets }}"
          scheduled_time: "{{ scheduled_time }}"
          created: "{{ now().isoformat() }}"
        safe_schedules: "{{ schedules if schedules is mapping else {} }}"
        updated_schedules: "{{ dict(safe_schedules, **{schedule_id: new_schedule}) }}"
    - event: jotty_scheduled_notes_update
      event_data:
        schedules: "{{ updated_schedules }}"
    - service: persistent_notification.create
      data:
        title: "Note Scheduled"
        message: "{{ title }} scheduled for {{ as_timestamp(scheduled_time) | timestamp_custom('%b %d at %I:%M %p') }}"
        notification_id: jotty_note_scheduled

jotty_cancel_scheduled_note:
  alias: "Jotty: Cancel Scheduled Note"
  fields:
    schedule_id:
      description: "Schedule ID to cancel"
  sequence:
    - variables:
        schedules: "{{ state_attr('sensor.jotty_scheduled_notes', 'schedules') or {} }}"
    - condition: template
      value_template: "{{ schedules is mapping and schedule_id in schedules }}"
    - variables:
        updated_schedules: >
          {% set safe_schedules = schedules if schedules is mapping else {} %}
          {% set ns = namespace(result={}) %}
          {% for key, val in safe_schedules.items() %}
            {% if key != schedule_id %}
              {% set ns.result = dict(ns.result, **{key: val}) %}
            {% endif %}
          {% endfor %}
          {{ ns.result }}
    - event: jotty_scheduled_notes_update
      event_data:
        schedules: "{{ updated_schedules }}"
    - service: persistent_notification.create
      data:
        title: "Scheduled Note Cancelled"
        message: "The scheduled note has been cancelled"
        notification_id: jotty_note_cancelled

jotty_send_scheduled_note:
  alias: "Jotty: Send Scheduled Note"
  fields:
    schedule_id:
      description: "Schedule ID"
    title:
      description: "Note title"
    message:
      description: "Note content"
    targets:
      description: "Comma-separated notify service targets"
  sequence:
    - variables:
        target_list: "{{ targets.split(',') }}"
    - repeat:
        count: "{{ target_list | length }}"
        sequence:
          - service: "{{ target_list[repeat.index - 1] }}"
            data:
              title: "{{ title }}"
              message: "{{ message }}"
              data:
                tag: "jotty_scheduled_{{ schedule_id }}"
    - variables:
        schedules: "{{ state_attr('sensor.jotty_scheduled_notes', 'schedules') or {} }}"
        updated_schedules: >
          {% set safe_schedules = schedules if schedules is mapping else {} %}
          {% set ns = namespace(result={}) %}
          {% for key, val in safe_schedules.items() %}
            {% if key != schedule_id %}
              {% set ns.result = dict(ns.result, **{key: val}) %}
            {% endif %}
          {% endfor %}
          {{ ns.result }}
    - event: jotty_scheduled_notes_update
      event_data:
        schedules: "{{ updated_schedules }}"

jotty_debug_scheduled_notes:
  alias: "Jotty: Debug Scheduled Notes"
  sequence:
    - variables:
        schedules: "{{ state_attr('sensor.jotty_scheduled_notes', 'schedules') or {} }}"
        schedules_count: "{{ schedules | length if schedules is mapping else 'NOT A MAPPING' }}"
        schedules_keys: "{{ schedules | list if schedules is mapping else [] }}"
        current_ts: "{{ now().timestamp() }}"
    - service: persistent_notification.create
      data:
        title: "Scheduled Notes Debug"
        message: >
          Schedules count: {{ schedules_count }}
          
          Keys: {{ schedules_keys }}
          
          Current timestamp: {{ current_ts }}
          
          Raw schedules: {{ schedules }}
        notification_id: jotty_debug

jotty_force_send_scheduled:
  alias: "Jotty: Force Send All Scheduled"
  sequence:
    - variables:
        schedules: "{{ state_attr('sensor.jotty_scheduled_notes', 'schedules') or {} }}"
    - condition: template
      value_template: "{{ schedules is mapping and schedules | length > 0 }}"
    - repeat:
        for_each: "{{ schedules | list }}"
        sequence:
          - variables:
              schedule_id: "{{ repeat.item }}"
              schedule: "{{ schedules[repeat.item] }}"
          - service: script.jotty_send_scheduled_note
            data:
              schedule_id: "{{ schedule_id }}"
              title: "{{ schedule.title | default('Note') }}"
              message: "{{ schedule.message | default('') }}"
              targets: "{{ schedule.targets | default('') }}"
      