# =============================================================================
# JOTTY HOME ASSISTANT INTEGRATION VIA HACS
# Copy and paste this at the bottom of scripts.yaml
# NOTE: All notes/lists automatically use "Home Assistant" category
# You MUST create the category "Home Assistant" in both Lists AND Notes
# =============================================================================

jotty_create_note:
  alias: "Jotty: Create Note"
  icon: mdi:note-plus
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.create_note
      data:
        title: "{{ states('input_text.jotty_note_title') }}"
        content: "{{ states('input_text.jotty_note_content') }}"
    ##- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_notes
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_note_title
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_note_content
      data:
        value: ""
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Note Created"
        message: "Your note has been created!"

jotty_update_note:
  alias: "Jotty: Update Note"
  icon: mdi:content-save
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.update_note
      data:
        note_id: "{{ states('input_text.jotty_note_id') }}"
        title: "{{ states('input_text.jotty_note_title') }}"
        content: "{{ states('input_text.jotty_note_content') }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_notes
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Note Updated"
        message: "Your note has been updated!"

jotty_delete_note:
  alias: "Jotty: Delete Note"
  icon: mdi:delete
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_note
      data:
        note_id: "{{ states('input_text.jotty_note_id') }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_notes
    - service: input_text.set_value
      target:
        entity_id:
          - input_text.jotty_note_id
          - input_text.jotty_note_title
          - input_text.jotty_note_content
      data:
        value: ""
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Note Deleted"
        message: "Your note has been deleted!"

jotty_create_checklist:
  alias: "Jotty: Create Checklist"
  icon: mdi:playlist-plus
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.create_checklist
      data:
        title: "{{ states('input_text.jotty_checklist_title') }}"
        type: "{{ states('input_select.jotty_checklist_type') }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_checklists
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_checklist_title
      data:
        value: ""
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Checklist Created"
        message: "Your checklist has been created!"

jotty_add_item:
  alias: "Jotty: Add Item"
  icon: mdi:plus
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.add_checklist_item
      data:
        checklist_id: "{{ states('input_text.jotty_checklist_id') }}"
        text: "{{ states('input_text.jotty_item_text') }}"
        status: >
          {% if states('input_select.jotty_checklist_type') == 'task' %}
            {{ states('input_select.jotty_task_status') }}
          {% endif %}
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_items
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_item_text
      data:
        value: ""
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Item Added"
        message: "Item added to checklist!"

jotty_check_item:
  alias: "Jotty: Check Item"
  icon: mdi:check-circle
  sequence:
    - service: jotty.check_item
      data:
        checklist_id: "{{ states('input_text.jotty_checklist_id') }}"
        item_index: "{{ states('input_number.jotty_selected_item_index') | int }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.jotty_completed_items
          - sensor.jotty_pending_items
          - sensor.jotty_completion_rate
    - service: persistent_notification.create
      data:
        title: "Item Checked"
        message: "Item marked as completed!"

jotty_uncheck_item:
  alias: "Jotty: Uncheck Item"
  icon: mdi:checkbox-blank-circle-outline
  sequence:
    - service: jotty.uncheck_item
      data:
        checklist_id: "{{ states('input_text.jotty_checklist_id') }}"
        item_index: "{{ states('input_number.jotty_selected_item_index') | int }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.jotty_completed_items
          - sensor.jotty_pending_items
          - sensor.jotty_completion_rate
    - service: persistent_notification.create
      data:
        title: "Item Unchecked"
        message: "Item marked as incomplete!"

jotty_delete_checklist:
  alias: "Jotty: Delete Checklist"
  icon: mdi:delete
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_checklist
      data:
        checklist_id: "{{ states('input_text.jotty_checklist_id') }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_checklists
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_checklist_id
      data:
        value: ""
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Checklist Deleted"
        message: "Your checklist has been deleted!"

jotty_force_update_note_picker:
  alias: "Jotty: Force Update Note Picker"
  icon: mdi:sync
  sequence:
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_notes
    #- delay: "00:00:00.5"
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_note_picker
      data:
        options: >-
          {%- set ns = namespace(items=['-- Pick a note --'], titles={}) -%}
          {%- set notes = states.sensor | selectattr('name', 'search', '^Jotty Note:') | rejectattr('state', 'eq', 'unavailable') | list -%}
          {%- for state in notes -%}
            {%- set title = state.state -%}
            {%- if title in ns.titles -%}
              {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
            {%- else -%}
              {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set ns2 = namespace(counts={}) -%}
          {%- for state in notes | sort(attribute='attributes.updated', reverse=true) -%}
            {%- set title = state.state -%}
            {%- set note_id = state_attr(state.entity_id, 'note_id') -%}
            {%- if ns.titles[title] > 1 -%}
              {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
              {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
              {%- set display_title = title ~ ' (' ~ note_id[-6:] ~ ')' -%}
            {%- else -%}
              {%- set display_title = title -%}
            {%- endif -%}
            {%- set ns.items = ns.items + [display_title] -%}
          {%- endfor -%}
          {{ ns.items }}

jotty_force_update_checklist_picker:
  alias: "Jotty: Force Update Checklist Picker"
  icon: mdi:sync
  sequence:
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_checklists
    #- delay: "00:00:00.5"
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_checklist_picker
      data:
        options: >-
          {%- set ns = namespace(items=['-- Pick a checklist --'], titles={}) -%}
          {%- set lists = states.sensor | selectattr('name', 'search', '^Jotty List:') | rejectattr('state', 'eq', 'unavailable') | list -%}
          {%- for state in lists -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- if title in ns.titles -%}
                {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
              {%- else -%}
                {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set ns2 = namespace(counts={}) -%}
          {%- for state in lists | sort(attribute='attributes.updated', reverse=true) -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- set list_id = state_attr(state.entity_id, 'checklist_id') -%}
              {%- if ns.titles[title] > 1 -%}
                {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
                {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
                {%- set display_title = title ~ ' (' ~ list_id[-6:] ~ ')' -%}
              {%- else -%}
                {%- set display_title = title -%}
              {%- endif -%}
              {%- set ns.items = ns.items + [display_title] -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.items }}

jotty_update_both_dropdowns:
  alias: "Jotty: Update Both Dropdowns"
  icon: mdi:sync-circle
  sequence:
    - service: script.jotty_force_update_note_picker
    #- delay: "00:00:00.3"
    - service: script.jotty_force_update_checklist_picker

jotty_save_edited_note:
  alias: "Jotty: Save Edited Note"
  icon: mdi:content-save
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.update_note
      data:
        note_id: "{{ states('input_text.jotty_note_id') }}"
        title: "{{ states('input_text.jotty_edit_note_title') }}"
        content: "{{ states('input_text.jotty_edit_note_content') }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_notes
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Note Saved"
        message: "Your changes have been saved!"

jotty_delete_edited_note:
  alias: "Jotty: Delete Edited Note"
  icon: mdi:delete
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_note
      data:
        note_id: "{{ states('input_text.jotty_note_id') }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_notes
    - service: input_text.set_value
      target:
        entity_id:
          - input_text.jotty_note_id
          - input_text.jotty_edit_note_title
          - input_text.jotty_edit_note_content
      data:
        value: ""
    - service: input_select.select_option
      target:
        entity_id: input_select.jotty_note_picker
      data:
        option: "-- Pick a note --"
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Note Deleted"
        message: "Note has been deleted!"

jotty_toggle_item_completion:
  alias: "Jotty: Toggle Item Completion"
  icon: mdi:checkbox-marked-circle-outline
  sequence:
    - variables:
        checklist_id: "{{ states('input_text.jotty_selected_checklist_id') }}"
        item_index: "{{ states('input_number.jotty_selected_item_index') | int }}"
        is_completed: "{{ states('input_boolean.jotty_item_completed') == 'on' }}"
    - condition: template
      value_template: "{{ checklist_id != '' and item_index >= 0 }}"
    - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_completed }}"
        sequence:
          - service: jotty.check_item
            data:
              checklist_id: "{{ checklist_id }}"
              item_index: "{{ item_index }}"
      default:
        - service: jotty.uncheck_item
          data:
            checklist_id: "{{ checklist_id }}"
            item_index: "{{ item_index }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.jotty_completed_items
          - sensor.jotty_pending_items
          - sensor.jotty_completion_rate
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_checklist_items
    - service: persistent_notification.create
      data:
        title: "Item Updated"
        message: "Item marked as {{ 'completed' if is_completed else 'incomplete' }}"

jotty_update_task_status:
  alias: "Jotty: Update Task Status"
  icon: mdi:list-status
  sequence:
    - variables:
        checklist_id: "{{ states('input_text.jotty_selected_checklist_id') }}"
        item_index: "{{ states('input_number.jotty_selected_item_index') | int }}"
        new_status: "{{ states('input_select.jotty_item_status') }}"
        list_type: "{{ states('input_text.jotty_selected_checklist_type') }}"
    - condition: template
      value_template: >
        {{ checklist_id != '' and 
           item_index >= 0 and 
           list_type == 'task' and
           new_status not in ['-- Select status --', ''] }}
    - choose:
      - conditions:
          - condition: template
            value_template: "{{ new_status == 'completed' }}"
        sequence:
          - service: jotty.check_item
            data:
              checklist_id: "{{ checklist_id }}"
              item_index: "{{ item_index }}"
      - conditions:
          - condition: template
            value_template: "{{ new_status in ['todo', 'in_progress', 'paused'] }}"
        sequence:
          - service: jotty.uncheck_item
            data:
              checklist_id: "{{ checklist_id }}"
              item_index: "{{ item_index }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.jotty_completed_items
          - sensor.jotty_pending_items
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_checklist_items
    - service: persistent_notification.create
      data:
        title: "Task Status Updated"
        message: "Task status changed to {{ new_status }}"

jotty_add_item_to_selected_list:
  alias: "Jotty: Add Item to Selected List"
  icon: mdi:plus-box
  sequence:
    - variables:
        checklist_id: "{{ states('input_text.jotty_selected_checklist_id') }}"
        list_type: "{{ states('input_text.jotty_selected_checklist_type') }}"
    - condition: template
      value_template: "{{ checklist_id != '' and states('input_text.jotty_item_text') != '' }}"
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - choose:
      - conditions:
          - condition: template
            value_template: "{{ list_type == 'task' }}"
        sequence:
          - service: jotty.add_checklist_item
            data:
              checklist_id: "{{ checklist_id }}"
              text: "{{ states('input_text.jotty_item_text') }}"
              status: "{{ states('input_select.jotty_task_status') if states('input_select.jotty_task_status') != '' else 'todo' }}"
      default:
        - service: jotty.add_checklist_item
          data:
            checklist_id: "{{ checklist_id }}"
            text: "{{ states('input_text.jotty_item_text') }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_items
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_item_text
      data:
        value: ""
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_checklist_items
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Item Added"
        message: "New item added to {{ states('input_text.jotty_selected_checklist_title') }}"

jotty_quick_check_item:
  alias: "Jotty: Quick Check Item"
  icon: mdi:check
  fields:
    item_index:
      description: "Index of the item to check"
      example: 0
  sequence:
    - variables:
        checklist_id: "{{ states('input_text.jotty_selected_checklist_id') }}"
    - condition: template
      value_template: "{{ checklist_id != '' }}"
    - service: jotty.check_item
      data:
        checklist_id: "{{ checklist_id }}"
        item_index: "{{ item_index }}"
    #- delay: "00:00:00.5"
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_checklist_items

jotty_quick_uncheck_item:
  alias: "Jotty: Quick Uncheck Item"
  icon: mdi:checkbox-blank-outline
  fields:
    item_index:
      description: "Index of the item to uncheck"
      example: 0
  sequence:
    - variables:
        checklist_id: "{{ states('input_text.jotty_selected_checklist_id') }}"
    - condition: template
      value_template: "{{ checklist_id != '' }}"
    - service: jotty.uncheck_item
      data:
        checklist_id: "{{ checklist_id }}"
        item_index: "{{ item_index }}"
    #- delay: "00:00:00.5"
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_checklist_items

jotty_refresh_dashboard_data:
  alias: "Jotty: Refresh Dashboard Data"
  icon: mdi:refresh
  sequence:
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.jotty_total_notes
          - sensor.jotty_total_checklists
          - sensor.jotty_total_items
          - sensor.jotty_completed_items
          - sensor.jotty_pending_items
          - sensor.jotty_completion_rate
    #- delay: "00:00:00.5"
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_note_picker
      data:
        options: >-
          {%- set ns = namespace(items=['-- Pick a note --'], titles={}) -%}
          {%- set notes = states.sensor | selectattr('name', 'search', '^Jotty Note:') | rejectattr('state', 'eq', 'unavailable') | list -%}
          {%- for state in notes -%}
            {%- set title = state.state -%}
            {%- if title in ns.titles -%}
              {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
            {%- else -%}
              {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set ns2 = namespace(counts={}) -%}
          {%- for state in notes | sort(attribute='attributes.updated', reverse=true) -%}
            {%- set title = state.state -%}
            {%- set note_id = state_attr(state.entity_id, 'note_id') -%}
            {%- if ns.titles[title] > 1 -%}
              {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
              {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
              {%- set display_title = title ~ ' (' ~ note_id[-6:] ~ ')' -%}
            {%- else -%}
              {%- set display_title = title -%}
            {%- endif -%}
            {%- set ns.items = ns.items + [display_title] -%}
          {%- endfor -%}
          {{ ns.items }}
    
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_checklist_picker
      data:
        options: >-
          {%- set ns = namespace(items=['-- Pick a checklist --'], titles={}) -%}
          {%- set lists = states.sensor | selectattr('name', 'search', '^Jotty List:') | rejectattr('state', 'eq', 'unavailable') | list -%}
          {%- for state in lists -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- if title in ns.titles -%}
                {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
              {%- else -%}
                {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set ns2 = namespace(counts={}) -%}
          {%- for state in lists | sort(attribute='attributes.updated', reverse=true) -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- set list_id = state_attr(state.entity_id, 'checklist_id') -%}
              {%- if ns.titles[title] > 1 -%}
                {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
                {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
                {%- set display_title = title ~ ' (' ~ list_id[-6:] ~ ')' -%}
              {%- else -%}
                {%- set display_title = title -%}
              {%- endif -%}
              {%- set ns.items = ns.items + [display_title] -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.items }}
    
    - service: persistent_notification.create
      data:
        title: "Jotty Refreshed"
        message: "Data and dropdowns updated!"

jotty_delete_note_by_id:
  alias: "Jotty: Delete Note by ID (Direct)"
  icon: mdi:delete
  fields:
    note_id:
      description: "The unique ID of the note to delete"
      example: "abc123"
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_note
      data:
        note_id: "{{ note_id }}"
    #- delay: "00:00:00.5"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_notes
    - service: script.jotty_refresh_dashboard_data
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Note Deleted"
        message: "Note has been deleted successfully!"
        
  
- id: jotty_auto_update_task_picker
  alias: "Jotty: Auto Update Task Picker"
  trigger:
    - platform: state
      entity_id:
        - sensor.jotty_total_tasks
    - platform: homeassistant
      event: start
  action:
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_task_picker
      data:
        options: >-
          {%- set ns = namespace(items=['-- Pick a task list --'], titles={}) -%}
          {%- set tasks = states.sensor | selectattr('name', 'search', '^Jotty Task:') | rejectattr('state', 'eq', 'unavailable') | list -%}
          {%- for state in tasks -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- if title in ns.titles -%}
                {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
              {%- else -%}
                {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set ns2 = namespace(counts={}) -%}
          {%- for state in tasks | sort(attribute='attributes.updated', reverse=true) -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- set task_id = state_attr(state.entity_id, 'task_id') -%}
              {%- if ns.titles[title] > 1 -%}
                {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
                {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
                {%- set display_title = title ~ ' (' ~ task_id[-6:] ~ ')' -%}
              {%- else -%}
                {%- set display_title = title -%}
              {%- endif -%}
              {%- set ns.items = ns.items + [display_title] -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.items }}

- id: jotty_load_task_when_picked
  alias: "Jotty: Load Task When Picked"
  trigger:
    - platform: state
      entity_id: input_select.jotty_task_picker
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable', '-- Pick a task list --'] }}"
  action:
    - variables:
        selected_option: "{{ states('input_select.jotty_task_picker') }}"
        selected_title: >-
          {%- if '(' in selected_option and selected_option.endswith(')') -%}
            {{ selected_option.split(' (')[0] }}
          {%- else -%}
            {{ selected_option }}
          {%- endif -%}
        task_id_hint: >-
          {%- if '(' in selected_option and selected_option.endswith(')') -%}
            {{ selected_option.split('(')[-1].rstrip(')') }}
          {%- else -%}
            
          {%- endif -%}
        task_entity: >-
          {%- for s in states.sensor -%}
            {%- if s.name.startswith('Jotty Task:') -%}
              {%- set title = state_attr(s.entity_id, 'title') -%}
              {%- set task_id = state_attr(s.entity_id, 'task_id') -%}
              {%- if task_id_hint and task_id and task_id.endswith(task_id_hint) -%}
                {{ s.entity_id }}
              {%- elif not task_id_hint and title == selected_title -%}
                {{ s.entity_id }}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
    - condition: template
      value_template: "{{ task_entity | trim != '' }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_selected_task_id
      data:
        value: "{{ state_attr(task_entity, 'task_id') or '' }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_selected_task_title
      data:
        value: "{{ state_attr(task_entity, 'title') or '' }}"

- id: jotty_load_task_items
  alias: "Jotty: Load Task Items"
  trigger:
    - platform: state
      entity_id: input_text.jotty_selected_task_id
  condition:
    - condition: template
      value_template: "{{ states('input_text.jotty_selected_task_id') not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        task_id: "{{ states('input_text.jotty_selected_task_id') }}"
        task_entity: >-
          {%- for s in states.sensor -%}
            {%- if s.name.startswith('Jotty Task:') -%}
              {%- if state_attr(s.entity_id, 'task_id') == task_id -%}
                {{ s.entity_id }}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
    - condition: template
      value_template: "{{ task_entity | trim != '' }}"
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_task_item_picker
      data:
        options: >-
          {%- set items = state_attr(task_entity, 'items') or [] -%}
          {%- set ns = namespace(options=['-- Select task item --']) -%}
          {%- for item in items -%}
            {%- set status_icon = 'â³' if item.status == 'todo' else ('ðŸ”„' if item.status == 'in_progress' else 'âœ…') -%}
            {%- set ns.options = ns.options + [loop.index0 ~ '. ' ~ status_icon ~ ' ' ~ item.text] -%}
          {%- endfor -%}
          {{ ns.options }}

- id: jotty_quick_task_actions
  alias: 'Jotty: Quick Task Actions from Card'
  mode: parallel
  max: 20
  trigger:
    - platform: state
      entity_id: input_text.jotty_quick_task_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != '' and trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - variables:
        action_data: "{{ states('input_text.jotty_quick_task_action_data').split('|||') }}"
        task_id: "{{ action_data[0] }}"
    - choose:
      - conditions:
          - condition: template
            value_template: "{{ action_data | length > 2 and action_data[2] == 'status' }}"
        sequence:
          - service: jotty.update_task_item_status
            data:
              task_id: "{{ task_id }}"
              item_index: "{{ action_data[1] | int }}"
              status: "{{ action_data[3] }}"
      - conditions:
          - condition: template
            value_template: "{{ action_data | length > 2 and action_data[2] == 'delete_item' }}"
        sequence:
          - service: jotty.delete_task_item
            data:
              task_id: "{{ task_id }}"
              item_index: "{{ action_data[1] | int }}"
      - conditions:
          - condition: template
            value_template: "{{ action_data | length > 1 and action_data[1] == 'add' }}"
        sequence:
          - service: jotty.add_task_item
            data:
              task_id: "{{ task_id }}"
              text: "{{ action_data[2] }}"
              status: "{{ action_data[3] if action_data | length > 3 else 'todo' }}"
      - conditions:
          - condition: template
            value_template: "{{ action_data | length > 1 and action_data[1] == 'delete' }}"
        sequence:
          - service: jotty.delete_task
            data:
              task_id: "{{ task_id }}"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_quick_task_action_data
      data:
        value: ""
        
- id: jotty_quick_list_delete_item
  alias: 'Jotty: Quick List Delete Item'
  description: 'Handles delete item action for checklists'
  mode: parallel
  max: 20
  trigger:
    - platform: state
      entity_id: input_text.jotty_quick_delete_item_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != '' and trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - variables:
        action_data: "{{ states('input_text.jotty_quick_delete_item_data').split('|||') }}"
        list_id: "{{ action_data[0] }}"
        item_index: "{{ action_data[1] | int }}"
    - service: jotty.delete_checklist_item
      data:
        checklist_id: "{{ list_id }}"
        item_index: "{{ item_index }}"
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.jotty_total_items
          - sensor.jotty_completed_items
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_quick_delete_item_data
      data:
        value: ""  
- id: jotty_kanban_actions
  alias: 'Jotty: Kanban Status Actions'
  mode: parallel
  max: 10
  trigger:
    - platform: state
      entity_id: input_text.jotty_kanban_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != '' and trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - variables:
        action_data: "{{ states('input_text.jotty_kanban_action_data').split('|||') }}"
        action_type: "{{ action_data[0] }}"
        task_id: "{{ action_data[1] }}"
    - choose:
      - conditions:
          - condition: template
            value_template: "{{ action_type == 'create_status' }}"
        sequence:
          - service: jotty.create_task_status
            data:
              task_id: "{{ task_id }}"
              status_id: "{{ action_data[2] }}"
              label: "{{ action_data[3] }}"
              color: "{{ action_data[4] if action_data | length > 4 else '#3b82f6' }}"
              order: "{{ action_data[5] | int if action_data | length > 5 else 0 }}"
      - conditions:
          - condition: template
            value_template: "{{ action_type == 'update_status' }}"
        sequence:
          - service: jotty.update_task_status
            data:
              task_id: "{{ task_id }}"
              status_id: "{{ action_data[2] }}"
              label: "{{ action_data[3] if action_data | length > 3 and action_data[3] != '' else none }}"
              color: "{{ action_data[4] if action_data | length > 4 and action_data[4] != '' else none }}"
              order: "{{ action_data[5] | int if action_data | length > 5 and action_data[5] != '' else none }}"
      - conditions:
          - condition: template
            value_template: "{{ action_type == 'delete_status' }}"
        sequence:
          - service: jotty.delete_task_status
            data:
              task_id: "{{ task_id }}"
              status_id: "{{ action_data[2] }}"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - delay:
        milliseconds: 500
    - service: script.jotty_load_task_statuses
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_kanban_action_data
      data:
        value: ""        

jotty_create_task:
  alias: "Jotty: Create Task List"
  icon: mdi:clipboard-plus
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.create_task
      data:
        title: "{{ states('input_text.jotty_task_title') }}"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_task_title
      data:
        value: ""
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Task List Created"
        message: "Your task list has been created!"

jotty_delete_task:
  alias: "Jotty: Delete Task List"
  icon: mdi:clipboard-remove
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_task
      data:
        task_id: "{{ states('input_text.jotty_selected_task_id') }}"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: input_text.set_value
      target:
        entity_id:
          - input_text.jotty_selected_task_id
          - input_text.jotty_selected_task_title
      data:
        value: ""
    - service: input_select.select_option
      target:
        entity_id: input_select.jotty_task_picker
      data:
        option: "-- Pick a task list --"
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Task List Deleted"
        message: "Your task list has been deleted!"

jotty_add_task_item:
  alias: "Jotty: Add Task Item"
  icon: mdi:clipboard-text-play
  sequence:
    - variables:
        task_id: "{{ states('input_text.jotty_selected_task_id') }}"
    - condition: template
      value_template: "{{ task_id != '' and states('input_text.jotty_task_item_text') != '' }}"
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.add_task_item
      data:
        task_id: "{{ task_id }}"
        text: "{{ states('input_text.jotty_task_item_text') }}"
        status: "{{ states('input_select.jotty_new_task_item_status') }}"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_task_item_text
      data:
        value: ""
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_task_items
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Task Item Added"
        message: "New task item added!"

jotty_update_task_item_status:
  alias: "Jotty: Update Task Item Status"
  icon: mdi:list-status
  fields:
    task_id:
      description: "Task list ID"
    item_index:
      description: "Item index"
    status:
      description: "New status"
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.update_task_item_status
      data:
        task_id: "{{ task_id }}"
        item_index: "{{ item_index }}"
        status: "{{ status }}"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading

jotty_delete_task_item:
  alias: "Jotty: Delete Task Item"
  icon: mdi:clipboard-minus
  fields:
    task_id:
      description: "Task list ID"
    item_index:
      description: "Item index"
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_task_item
      data:
        task_id: "{{ task_id }}"
        item_index: "{{ item_index }}"
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_task_items
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Task Item Deleted"
        message: "Task item has been deleted!"

jotty_delete_checklist_item:
  alias: "Jotty: Delete Checklist Item"
  icon: mdi:delete
  fields:
    checklist_id:
      description: "Checklist ID"
    item_index:
      description: "Item index"
  sequence:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_checklist_item
      data:
        checklist_id: "{{ checklist_id }}"
        item_index: "{{ item_index }}"
    - service: homeassistant.update_entity
      target:
        entity_id:
          - sensor.jotty_total_items
          - sensor.jotty_completed_items
    - service: automation.trigger
      target:
        entity_id: automation.jotty_load_checklist_items
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: persistent_notification.create
      data:
        title: "Item Deleted"
        message: "Checklist item has been deleted!"

jotty_force_update_task_picker:
  alias: "Jotty: Force Update Task Picker"
  icon: mdi:sync
  sequence:
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_task_picker
      data:
        options: >-
          {%- set ns = namespace(items=['-- Pick a task list --'], titles={}) -%}
          {%- set tasks = states.sensor | selectattr('name', 'search', '^Jotty Task:') | rejectattr('state', 'eq', 'unavailable') | list -%}
          {%- for state in tasks -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- if title in ns.titles -%}
                {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
              {%- else -%}
                {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- set ns2 = namespace(counts={}) -%}
          {%- for state in tasks | sort(attribute='attributes.updated', reverse=true) -%}
            {%- set title = state_attr(state.entity_id, 'title') -%}
            {%- if title -%}
              {%- set task_id = state_attr(state.entity_id, 'task_id') -%}
              {%- if ns.titles[title] > 1 -%}
                {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
                {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
                {%- set display_title = title ~ ' (' ~ task_id[-6:] ~ ')' -%}
              {%- else -%}
                {%- set display_title = title -%}
              {%- endif -%}
              {%- set ns.items = ns.items + [display_title] -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.items }}
jotty_load_task_statuses:
  alias: "Jotty: Load Task Statuses"
  sequence:
    - variables:
        task_id: "{{ states('input_text.jotty_selected_task_id') }}"
        status_options: >
          {% set ns = namespace(options=['-- Select status --']) %}
          {% for state in states.sensor %}
            {% if state.name.startswith('Jotty Task:') %}
              {% if state_attr(state.entity_id, 'task_id') == task_id %}
                {% set statuses = state_attr(state.entity_id, 'statuses') or [] %}
                {% for status in statuses | sort(attribute='order') %}
                  {% set ns.options = ns.options + [status.name ~ ' (' ~ status.id ~ ')'] %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ ns.options }}
    - service: input_select.set_options
      target:
        entity_id: input_select.jotty_status_picker
      data:
        options: "{{ status_options }}"

jotty_create_kanban_status:
  alias: "Jotty: Create Kanban Status"
  sequence:
    - condition: template
      value_template: >
        {{ states('input_text.jotty_selected_task_id') | trim | length > 0 and
           states('input_text.jotty_new_status_id') | trim | length > 0 and
           states('input_text.jotty_new_status_label') | trim | length > 0 }}
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.create_task_status
      data:
        task_id: "{{ states('input_text.jotty_selected_task_id') }}"
        status_id: "{{ states('input_text.jotty_new_status_id') }}"
        label: "{{ states('input_text.jotty_new_status_label') }}"
        color: "{{ states('input_text.jotty_new_status_color') }}"
        order: "{{ states('input_number.jotty_new_status_order') | int }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_new_status_id
      data:
        value: ""
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_new_status_label
      data:
        value: ""
    - delay:
        milliseconds: 500
    - service: script.jotty_load_task_statuses
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading

jotty_update_kanban_status:
  alias: "Jotty: Update Kanban Status"
  sequence:
    - condition: template
      value_template: >
        {{ states('input_text.jotty_selected_task_id') | trim | length > 0 and
           states('input_text.jotty_edit_status_id') | trim | length > 0 }}
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.update_task_status
      data:
        task_id: "{{ states('input_text.jotty_selected_task_id') }}"
        status_id: "{{ states('input_text.jotty_edit_status_id') }}"
        label: "{{ states('input_text.jotty_edit_status_label') if states('input_text.jotty_edit_status_label') | trim | length > 0 else none }}"
        color: "{{ states('input_text.jotty_edit_status_color') if states('input_text.jotty_edit_status_color') | trim | length > 0 else none }}"
    - delay:
        milliseconds: 500
    - service: script.jotty_load_task_statuses
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading

jotty_delete_kanban_status:
  alias: "Jotty: Delete Kanban Status"
  fields:
    status_id:
      description: "Status ID to delete"
      example: "review"
  sequence:
    - condition: template
      value_template: "{{ states('input_text.jotty_selected_task_id') | trim | length > 0 }}"
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jotty_is_loading
    - service: jotty.delete_task_status
      data:
        task_id: "{{ states('input_text.jotty_selected_task_id') }}"
        status_id: "{{ status_id }}"
    - delay:
        milliseconds: 500
    - service: script.jotty_load_task_statuses
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.jotty_is_loading                  