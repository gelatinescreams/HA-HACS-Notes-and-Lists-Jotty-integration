- id: jotty_auto_update_note_picker_fixed
  alias: 'Jotty: Auto Update Note Picker'
  trigger:
  - platform: state
    entity_id:
    - sensor.jotty_total_notes
  - platform: homeassistant
    event: start
  action:
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_note_picker
    data:
      options: >
        {%- set ns = namespace(items=['-- Pick a note --'], titles={}) -%}
        {%- set notes = states.sensor | selectattr('name', 'search', '^Jotty Note:')
        | rejectattr('state', 'eq', 'unavailable') | list -%}
        {%- for state in notes -%}
          {%- set title = state.state -%}
          {%- if title in ns.titles -%}
            {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
          {%- else -%}
            {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set ns2 = namespace(counts={}) -%}
        {%- for state in notes | sort(attribute='attributes.updated', reverse=true) -%}
          {%- set title = state.state -%}
          {%- set note_id = state_attr(state.entity_id, 'note_id') -%}
          {%- if ns.titles[title] > 1 -%}
            {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
            {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
            {%- set display_title = title ~ ' (' ~ note_id[-6:] ~ ')' -%}
          {%- else -%}
            {%- set display_title = title -%}
          {%- endif -%}
          {%- set ns.items = ns.items + [display_title] -%}
        {%- endfor -%}
        {{ ns.items }}

- id: jotty_auto_update_checklist_picker_fixed
  alias: 'Jotty: Auto Update Checklist Picker'
  trigger:
  - platform: state
    entity_id:
    - sensor.jotty_total_checklists
  - platform: homeassistant
    event: start
  action:
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_checklist_picker
    data:
      options: >
        {%- set ns = namespace(items=['-- Pick a checklist --'], titles={}) -%}
        {%- set lists = states.sensor | selectattr('name', 'search', '^Jotty List:')
        | rejectattr('state', 'eq', 'unavailable') | list -%}
        {%- for state in lists -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- if title in ns.titles -%}
              {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
            {%- else -%}
              {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set ns2 = namespace(counts={}) -%}
        {%- for state in lists | sort(attribute='attributes.updated', reverse=true) -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- set list_id = state_attr(state.entity_id, 'checklist_id') -%}
            {%- if ns.titles[title] > 1 -%}
              {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
              {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
              {%- set display_title = title ~ ' (' ~ list_id[-6:] ~ ')' -%}
            {%- else -%}
              {%- set display_title = title -%}
            {%- endif -%}
            {%- set ns.items = ns.items + [display_title] -%}
          {%- endif -%}
        {%- endfor -%}
        {{ ns.items }}

- id: jotty_auto_update_task_picker_fixed
  alias: 'Jotty: Auto Update Task Picker'
  trigger:
  - platform: state
    entity_id:
    - sensor.jotty_total_tasks
  - platform: homeassistant
    event: start
  action:
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_task_picker
    data:
      options: >
        {%- set ns = namespace(items=['-- Pick a task list --'], titles={}) -%}
        {%- set tasks = states.sensor | selectattr('name', 'search', '^Jotty Task:')
        | rejectattr('state', 'eq', 'unavailable') | list -%}
        {%- for state in tasks -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- if title in ns.titles -%}
              {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}
            {%- else -%}
              {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set ns2 = namespace(counts={}) -%}
        {%- for state in tasks | sort(attribute='attributes.updated', reverse=true) -%}
          {%- set title = state_attr(state.entity_id, 'title') -%}
          {%- if title -%}
            {%- set task_id = state_attr(state.entity_id, 'task_id') -%}
            {%- if ns.titles[title] > 1 -%}
              {%- set current_count = ns2.counts.get(title, 0) + 1 -%}
              {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}
              {%- set display_title = title ~ ' (' ~ task_id[-6:] ~ ')' -%}
            {%- else -%}
              {%- set display_title = title -%}
            {%- endif -%}
            {%- set ns.items = ns.items + [display_title] -%}
          {%- endif -%}
        {%- endfor -%}
        {{ ns.items }}

- id: jotty_load_note_when_picked
  alias: 'Jotty: Load Note When Picked'
  trigger:
  - platform: state
    entity_id: input_select.jotty_note_picker
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.state not in [''unknown'', ''unavailable'', ''-- Pick a note --''] }}'
  action:
  - variables:
      selected_option: '{{ states(''input_select.jotty_note_picker'') }}'
      selected_title: >
        {%- if '(' in selected_option and selected_option.endswith(')') -%}
          {{ selected_option.split(' (')[0] }}
        {%- else -%}
          {{ selected_option }}
        {%- endif -%}
      note_id_hint: >
        {%- if '(' in selected_option and selected_option.endswith(')') -%}
          {{ selected_option.split('(')[-1].rstrip(')') }}
        {%- else -%}
        {%- endif -%}
      note_entity: >
        {%- for s in states.sensor -%}
          {%- if s.name.startswith('Jotty Note:') -%}
            {%- if note_id_hint and state_attr(s.entity_id, 'note_id') and state_attr(s.entity_id, 'note_id').endswith(note_id_hint) -%}
              {{ s.entity_id }}
            {%- elif not note_id_hint and s.state == selected_title -%}
              {{ s.entity_id }}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
  - condition: template
    value_template: '{{ note_entity | trim != '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_note_id
    data:
      value: '{{ state_attr(note_entity, ''note_id'') or '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_edit_note_title
    data:
      value: '{{ states(note_entity) }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_edit_note_content
    data:
      value: '{{ state_attr(note_entity, ''content'') or '''' }}'

- id: jotty_load_checklist_when_picked
  alias: 'Jotty: Load Checklist When Picked'
  trigger:
  - platform: state
    entity_id: input_select.jotty_checklist_picker
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.state not in [''unknown'', ''unavailable'', ''-- Pick a checklist --''] }}'
  action:
  - variables:
      selected_option: '{{ states(''input_select.jotty_checklist_picker'') }}'
      selected_title: >
        {%- if '(' in selected_option and selected_option.endswith(')') -%}
          {{ selected_option.split(' (')[0] }}
        {%- else -%}
          {{ selected_option }}
        {%- endif -%}
      list_id_hint: >
        {%- if '(' in selected_option and selected_option.endswith(')') -%}
          {{ selected_option.split('(')[-1].rstrip(')') }}
        {%- else -%}
        {%- endif -%}
      list_entity: >
        {%- for s in states.sensor -%}
          {%- if s.name.startswith('Jotty List:') -%}
            {%- set title = state_attr(s.entity_id, 'title') -%}
            {%- set list_id = state_attr(s.entity_id, 'checklist_id') -%}
            {%- if list_id_hint and list_id and list_id.endswith(list_id_hint) -%}
              {{ s.entity_id }}
            {%- elif not list_id_hint and title == selected_title -%}
              {{ s.entity_id }}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
  - condition: template
    value_template: '{{ list_entity | trim != '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_selected_checklist_id
    data:
      value: '{{ state_attr(list_entity, ''checklist_id'') or '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_selected_checklist_title
    data:
      value: '{{ state_attr(list_entity, ''title'') or '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_selected_checklist_type
    data:
      value: '{{ state_attr(list_entity, ''type'') or ''simple'' }}'

- id: jotty_load_task_when_picked
  alias: 'Jotty: Load Task When Picked'
  trigger:
  - platform: state
    entity_id: input_select.jotty_task_picker
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.state not in [''unknown'', ''unavailable'', ''-- Pick a task list --''] }}'
  action:
  - variables:
      selected_option: '{{ states(''input_select.jotty_task_picker'') }}'
      selected_title: >
        {%- if '(' in selected_option and selected_option.endswith(')') -%}
          {{ selected_option.split(' (')[0] }}
        {%- else -%}
          {{ selected_option }}
        {%- endif -%}
      task_id_hint: >
        {%- if '(' in selected_option and selected_option.endswith(')') -%}
          {{ selected_option.split('(')[-1].rstrip(')') }}
        {%- else -%}
        {%- endif -%}
      task_entity: >
        {%- for s in states.sensor -%}
          {%- if s.name.startswith('Jotty Task:') -%}
            {%- set title = state_attr(s.entity_id, 'title') -%}
            {%- set task_id = state_attr(s.entity_id, 'task_id') -%}
            {%- if task_id_hint and task_id and task_id.endswith(task_id_hint) -%}
              {{ s.entity_id }}
            {%- elif not task_id_hint and title == selected_title -%}
              {{ s.entity_id }}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
  - condition: template
    value_template: '{{ task_entity | trim != '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_selected_task_id
    data:
      value: '{{ state_attr(task_entity, ''task_id'') or '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jotty_selected_task_title
    data:
      value: '{{ state_attr(task_entity, ''title'') or '''' }}'

- id: jotty_load_checklist_items
  alias: 'Jotty: Load Checklist Items'
  trigger:
  - platform: state
    entity_id: input_text.jotty_selected_checklist_id
  condition:
  - condition: template
    value_template: '{{ states(''input_text.jotty_selected_checklist_id'') not in ['''', ''unknown'', ''unavailable''] }}'
  action:
  - variables:
      checklist_id: '{{ states(''input_text.jotty_selected_checklist_id'') }}'
      list_entity: >
        {%- for s in states.sensor -%}
          {%- if s.name.startswith('Jotty List:') -%}
            {%- if state_attr(s.entity_id, 'checklist_id') == checklist_id -%}
              {{ s.entity_id }}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
  - condition: template
    value_template: '{{ list_entity | trim != '''' }}'
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_item_picker
    data:
      options: >
        {%- set items = state_attr(list_entity, 'items') or [] -%}
        {%- set ns = namespace(opts=['-- Select item --']) -%}
        {%- for item in items -%}
          {%- set ns.opts = ns.opts + [item.text | default('Item ' ~ loop.index)] -%}
        {%- endfor -%}
        {{ ns.opts }}

- id: jotty_load_task_items
  alias: 'Jotty: Load Task Items'
  trigger:
  - platform: state
    entity_id: input_text.jotty_selected_task_id
  condition:
  - condition: template
    value_template: '{{ states(''input_text.jotty_selected_task_id'') not in ['''', ''unknown'', ''unavailable''] }}'
  action:
  - variables:
      task_id: '{{ states(''input_text.jotty_selected_task_id'') }}'
      task_entity: >
        {%- for s in states.sensor -%}
          {%- if s.name.startswith('Jotty Task:') -%}
            {%- if state_attr(s.entity_id, 'task_id') == task_id -%}
              {{ s.entity_id }}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
  - condition: template
    value_template: '{{ task_entity | trim != '''' }}'
  - service: input_select.set_options
    target:
      entity_id: input_select.jotty_task_item_picker
    data:
      options: >
        {%- set items = state_attr(task_entity, 'items') or [] -%}
        {%- set ns = namespace(opts=['-- Select task item --']) -%}
        {%- for item in items -%}
          {%- set ns.opts = ns.opts + [item.text | default('Item ' ~ loop.index)] -%}
        {%- endfor -%}
        {{ ns.opts }}

- id: jotty_process_reminders
  alias: "Jotty: Process Reminders"
  trigger:
    - platform: time_pattern
      minutes: "/1"
  action:
    - variables:
        configs: "{{ state_attr('sensor.jotty_reminders', 'configs') or {} }}"
        current_time: "{{ now().strftime('%H:%M') }}"
        current_day: "{{ now().strftime('%A') }}"
        is_weekday: "{{ current_day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] }}"
    - condition: template
      value_template: "{{ configs is mapping and configs | length > 0 }}"
    - repeat:
        for_each: "{{ configs.keys() | list if configs is mapping else [] }}"
        sequence:
          - variables:
              item_id: "{{ repeat.item }}"
              config: "{{ configs[item_id] if configs[repeat.item] is defined else {} }}"
              item_type: "{{ config.type | default('checklist') }}"
              days: "{{ config.days | default('every_day') }}"
              interval: "{{ config.interval | default('1 hour') }}"
              start_time: "{{ config.start | default('08:00') }}"
              end_time: "{{ config.end | default('20:00') }}"
              last_sent: "{{ config.last_sent | default('') }}"
              should_run_today: >
                {% if days == 'weekdays' %}
                  {{ is_weekday }}
                {% elif days == 'weekends' %}
                  {{ not is_weekday }}
                {% else %}
                  true
                {% endif %}
          - condition: template
            value_template: "{{ should_run_today }}"
          - condition: template
            value_template: "{{ current_time >= start_time and current_time <= end_time }}"
          - condition: template
            value_template: >
              {% if last_sent == '' %}
                true
              {% else %}
                {% set last_ts = as_timestamp(strptime(last_sent, '%Y-%m-%d %H:%M', now())) %}
                {% set now_ts = as_timestamp(now()) %}
                {% set mins = ((now_ts - last_ts) / 60) | int %}
                {% if interval == '30 minutes' %}{{ mins >= 30 }}
                {% elif interval == '1 hour' %}{{ mins >= 60 }}
                {% elif interval == '2 hours' %}{{ mins >= 120 }}
                {% elif interval == '4 hours' %}{{ mins >= 240 }}
                {% elif interval == '8 hours' %}{{ mins >= 480 }}
                {% elif interval == '12 hours' %}{{ mins >= 720 }}
                {% else %}{{ mins >= 1440 }}
                {% endif %}
              {% endif %}
          - variables:
              sensor_entity: >
                {% set ns = namespace(found='') %}
                {% if item_type == 'task' %}
                  {% for s in states.sensor %}
                    {% if s.attributes.task_id is defined and s.attributes.task_id == item_id %}
                      {% set ns.found = s.entity_id %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  {% for s in states.sensor %}
                    {% if s.attributes.checklist_id is defined and s.attributes.checklist_id == item_id %}
                      {% set ns.found = s.entity_id %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {{ ns.found }}
          - condition: template
            value_template: "{{ sensor_entity | trim != '' }}"
          - variables:
              total_items: "{{ state_attr(sensor_entity, 'total') | int(0) }}"
              completed_items: "{{ state_attr(sensor_entity, 'completed') | int(0) }}"
              has_incomplete: "{{ total_items > completed_items }}"
              item_title: "{{ state_attr(sensor_entity, 'title') | default('Reminder') }}"
              incomplete_count: "{{ total_items - completed_items }}"
          - condition: template
            value_template: "{{ has_incomplete }}"
          - variables:
              custom_title: "{{ config.custom_title | default('') }}"
              custom_message: "{{ config.custom_message | default('') }}"
              targets: "{{ config.targets | default(config.target | default('')) }}"
              target_list: "{{ targets.split(',') if targets else [] }}"
              notification_title: "{% if custom_title != '' %}{{ custom_title }}{% else %}{{ item_title }}{% endif %}"
              notification_message: >
                {% if custom_message != '' %}
                  {{ custom_message }}
                {% else %}
                  {% set items = state_attr(sensor_entity, 'flat_items') | default([]) %}
                  {% set ns = namespace(pending=[]) %}
                  {% for item in items %}
                    {% if item_type == 'task' %}
                      {% if item.status | default('todo') != 'completed' %}
                        {% set ns.pending = ns.pending + [item.text | default(item.name | default('?'))] %}
                      {% endif %}
                    {% else %}
                      {% if not item.completed | default(false) %}
                        {% set ns.pending = ns.pending + [item.text | default(item.name | default('?'))] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.pending | length > 5 %}
                    {{ ns.pending[:5] | join(', ') }}, +{{ ns.pending | length - 5 }} more
                  {% else %}
                    {{ ns.pending | join(', ') }}
                  {% endif %}
                {% endif %}
          - repeat:
              count: "{{ target_list | length }}"
              sequence:
                - service: "{{ target_list[repeat.index - 1] }}"
                  data:
                    title: "{{ notification_title }}"
                    message: "{{ notification_message }}"
                    data:
                      tag: "jotty_{{ item_id }}"
                      actions:
                        - action: "JOTTY_OPEN_{{ item_id }}"
                          title: "Open"
                        - action: "JOTTY_SNOOZE_{{ item_id }}"
                          title: "Snooze"
          - service: script.jotty_update_last_sent
            data:
              item_id: "{{ item_id }}"

- id: jotty_handle_notification_actions
  alias: 'Jotty: Handle Notification Actions'
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
  condition:
  - condition: template
    value_template: '{{ trigger.event.data.action.startswith(''JOTTY_'') }}'
  action:
  - variables:
      action: '{{ trigger.event.data.action }}'
      item_id: '{{ action.split(''_'', 2)[2] if action.split(''_'') | length > 2 else '''' }}'
  - choose:
    - conditions: '{{ ''SNOOZE'' in action }}'
      sequence:
      - service: script.jotty_update_last_sent
        data:
          item_id: '{{ item_id }}'
    - conditions: '{{ ''OPEN'' in action }}'
      sequence:
      - service: persistent_notification.create
        data:
          title: "ðŸ“ Jotty Item"
          message: Open your Jotty dashboard to view this item.
          notification_id: jotty_open_{{ item_id }}

- id: jotty_check_recurring_resets
  alias: "Jotty: Check Recurring Resets"
  trigger:
    - platform: time_pattern
      minutes: "/1"
  action:
    - variables:
        configs: "{{ state_attr('sensor.jotty_recurring', 'configs') or {} }}"
        current_time: "{{ now().strftime('%H:%M') }}"
        current_day: "{{ now().strftime('%A') }}"
        is_weekday: "{{ current_day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] }}"
    - condition: template
      value_template: "{{ configs is mapping and configs | length > 0 }}"
    - repeat:
        for_each: "{{ configs.keys() | list if configs is mapping else [] }}"
        sequence:
          - variables:
              item_id: "{{ repeat.item }}"
              config: "{{ configs[item_id] if configs[repeat.item] is defined else {} }}"
              item_type: "{{ config.type | default('checklist') }}"
              days: "{{ config.days | default('every_day') }}"
              reset_times: "{{ config.reset_times | default([]) if config.reset_times is defined else [] }}"
              should_run_today: >
                {% if days == 'weekdays' %}
                  {{ is_weekday }}
                {% elif days == 'weekends' %}
                  {{ not is_weekday }}
                {% else %}
                  true
                {% endif %}
              time_matches: "{{ current_time in reset_times }}"
          - condition: template
            value_template: "{{ should_run_today and time_matches }}"
          - choose:
              - conditions: "{{ item_type == 'task' }}"
                sequence:
                  - service: script.jotty_reset_task
                    data:
                      task_id: "{{ item_id }}"
              - conditions: "{{ item_type == 'checklist' }}"
                sequence:
                  - service: script.jotty_reset_checklist
                    data:
                      checklist_id: "{{ item_id }}"

- id: jotty_process_scheduled_notes
  alias: "Jotty: Process Scheduled Notes"
  trigger:
    - platform: time_pattern
      minutes: "/1"
  action:
    - variables:
        schedules: "{{ state_attr('sensor.jotty_scheduled_notes', 'schedules') or {} }}"
        current_ts: "{{ now().timestamp() | int }}"
    - condition: template
      value_template: "{{ schedules is mapping and schedules | length > 0 }}"
    - repeat:
        for_each: "{{ schedules.keys() | list if schedules is mapping else [] }}"
        sequence:
          - variables:
              schedule_id: "{{ repeat.item }}"
              schedule: "{{ schedules[schedule_id] if schedules[schedule_id] is defined else {} }}"
              scheduled_time: "{{ schedule.scheduled_time | default('') }}"
              scheduled_ts: "{{ as_timestamp(scheduled_time) | int if scheduled_time else 0 }}"
              is_due: "{{ scheduled_ts > 0 and current_ts >= scheduled_ts }}"
          - condition: template
            value_template: "{{ is_due }}"
          - service: script.jotty_send_scheduled_note
            data:
              schedule_id: "{{ schedule_id }}"
              title: "{{ schedule.title | default('Note') }}"
              message: "{{ schedule.message | default('') }}"
              targets: "{{ schedule.targets | default('') }}"
              
- id: jotty_process_quick_action
  alias: "Jotty: Process Quick Action"
  description: "Handles check/uncheck/add/delete actions from the dashboard"
  trigger:
    - platform: state
      entity_id: input_text.jotty_quick_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        data: "{{ trigger.to_state.state }}"
        parts: "{{ data.split('|||') }}"
        list_id: "{{ parts[0] if parts | length > 0 else '' }}"
        action_or_index: "{{ parts[1] if parts | length > 1 else '' }}"
        action_type: "{{ parts[2] if parts | length > 2 else '' }}"
    - choose:
        - conditions: "{{ action_type == 'check' }}"
          sequence:
            - service: jotty.check_item
              data:
                checklist_id: "{{ list_id }}"
                item_index: "{{ action_or_index }}"
            - delay:
                milliseconds: 500
            - service: homeassistant.update_entity
              target:
                entity_id:
                  - sensor.jotty_completed_items
                  - sensor.jotty_pending_items
        - conditions: "{{ action_type == 'uncheck' }}"
          sequence:
            - service: jotty.uncheck_item
              data:
                checklist_id: "{{ list_id }}"
                item_index: "{{ action_or_index }}"
            - delay:
                milliseconds: 500
            - service: homeassistant.update_entity
              target:
                entity_id:
                  - sensor.jotty_completed_items
                  - sensor.jotty_pending_items
        - conditions: "{{ action_or_index == 'add' }}"
          sequence:
            - service: jotty.add_checklist_item
              data:
                checklist_id: "{{ list_id }}"
                text: "{{ action_type }}"
            - delay:
                milliseconds: 500
            - service: homeassistant.update_entity
              target:
                entity_id: sensor.jotty_total_items
        - conditions: "{{ action_or_index == 'delete' }}"
          sequence:
            - service: jotty.delete_checklist
              data:
                checklist_id: "{{ list_id }}"
            - delay:
                milliseconds: 500
            - service: homeassistant.update_entity
              target:
                entity_id: sensor.jotty_total_checklists
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_quick_action_data
      data:
        value: ""

- id: jotty_process_quick_delete_item
  alias: "Jotty: Process Quick Delete Item"
  description: "Handles item deletion from the dashboard"
  trigger:
    - platform: state
      entity_id: input_text.jotty_quick_delete_item_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        data: "{{ trigger.to_state.state }}"
        parts: "{{ data.split('|||') }}"
        list_id: "{{ parts[0] if parts | length > 0 else '' }}"
        item_index: "{{ parts[1] if parts | length > 1 else '' }}"
    - service: jotty.delete_checklist_item
      data:
        checklist_id: "{{ list_id }}"
        item_index: "{{ item_index }}"
    - delay:
        milliseconds: 500
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_items
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_quick_delete_item_data
      data:
        value: ""

- id: jotty_process_quick_task_action
  alias: "Jotty: Process Quick Task Action"
  description: "Handles task status changes from the dashboard"
  trigger:
    - platform: state
      entity_id: input_text.jotty_quick_task_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        data: "{{ trigger.to_state.state }}"
        parts: "{{ data.split('|||') }}"
        task_id: "{{ parts[0] if parts | length > 0 else '' }}"
        action_or_index: "{{ parts[1] if parts | length > 1 else '' }}"
        action_data: "{{ parts[2] if parts | length > 2 else '' }}"
    - choose:
        - conditions: "{{ action_or_index | int(-1) >= 0 or '.' in action_or_index }}"
          sequence:
            - service: jotty.update_task_item_status
              data:
                task_id: "{{ task_id }}"
                item_index: "{{ action_or_index }}"
                status: "{{ action_data }}"
            - delay:
                milliseconds: 500
            - service: homeassistant.update_entity
              target:
                entity_id: sensor.jotty_total_tasks
        - conditions: "{{ action_or_index == 'add' }}"
          sequence:
            - service: jotty.add_task_item
              data:
                task_id: "{{ task_id }}"
                text: "{{ action_data }}"
                status: "todo"
            - delay:
                milliseconds: 500
            - service: homeassistant.update_entity
              target:
                entity_id: sensor.jotty_total_tasks
        - conditions: "{{ action_or_index == 'delete' }}"
          sequence:
            - service: jotty.delete_task
              data:
                task_id: "{{ task_id }}"
            - delay:
                milliseconds: 500
            - service: homeassistant.update_entity
              target:
                entity_id: sensor.jotty_total_tasks
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_quick_task_action_data
      data:
        value: ""

- id: jotty_process_kanban_action
  alias: "Jotty: Process Kanban Action"
  description: "Handles Kanban board actions from the dashboard"
  trigger:
    - platform: state
      entity_id: input_text.jotty_kanban_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        data: "{{ trigger.to_state.state }}"
        parts: "{{ data.split('|||') }}"
        task_id: "{{ parts[0] if parts | length > 0 else '' }}"
        item_index: "{{ parts[1] if parts | length > 1 else '' }}"
        new_status: "{{ parts[2] if parts | length > 2 else '' }}"
    - service: jotty.update_task_item_status
      data:
        task_id: "{{ task_id }}"
        item_index: "{{ item_index }}"
        status: "{{ new_status }}"
    - delay:
        milliseconds: 500
    - service: homeassistant.update_entity
      target:
        entity_id: sensor.jotty_total_tasks
    - service: input_text.set_value
      target:
        entity_id: input_text.jotty_kanban_action_data
      data:
        value: ""              